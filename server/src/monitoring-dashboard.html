<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>모니터링 대시보드</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: white;
    }

    h1 {
      text-align: center;
      border-bottom: 2px solid black;
      padding-bottom: 10px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .metric-card {
      border: 2px solid black;
      padding: 20px;
    }

    .metric-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .metric-value {
      font-size: 48px;
      font-weight: bold;
    }

    .metric-unit {
      font-size: 14px;
      color: #666;
    }

    .chart-container {
      border: 2px solid black;
      padding: 20px;
      margin-bottom: 20px;
    }

    .chart-title {
      font-weight: bold;
      margin-bottom: 15px;
    }

    .last-update {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h1>모니터링 대시보드</h1>

  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-title">총 요청 수</div>
      <div class="metric-value" id="total-requests">0</div>
      <div class="metric-unit">요청</div>
    </div>

    <div class="metric-card">
      <div class="metric-title">평균 지연 시간</div>
      <div class="metric-value" id="avg-latency">0</div>
      <div class="metric-unit">ms</div>
    </div>

    <div class="metric-card">
      <div class="metric-title">에러율</div>
      <div class="metric-value" id="error-rate">0</div>
      <div class="metric-unit">%</div>
    </div>
  </div>

  <div class="chart-container">
    <div class="chart-title">요청 수 추이(최근 1분 기준 평균 요청 수)</div>
    <canvas id="requestsChart"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-title">지연 시간 & 에러율 추이</div>
    <canvas id="performanceChart"></canvas>
  </div>

  <div class="last-update">
    마지막 업데이트: <span id="last-update">-</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    /** ===============================
     *  토큰 준비
     *  =============================== */
    const TOKEN = localStorage.getItem("accessToken");

    if (!TOKEN) {
      alert("accessToken이 없습니다. 관리자 로그인 후 다시 열어주세요.");
      throw new Error("No accessToken");
    }

    /** ===============================
     *  Chart 초기화
     *  =============================== */
    const monitoringData = {
      labels: [],
      requests: [],
      latency: [],
      errorRate: [],
      max: 20
    };

    const requestsChart = new Chart(
      document.getElementById("requestsChart"),
      {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "요청 수",
              data: [],
              borderColor: "black",
              borderWidth: 2
            }
          ]
        }
      }
    );

    const performanceChart = new Chart(
      document.getElementById("performanceChart"),
      {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "평균 지연 (ms)",
              data: [],
              borderColor: "black",
              yAxisID: "y"
            },
            {
              label: "에러율 (%)",
              data: [],
              borderColor: "#666",
              yAxisID: "y1"
            }
          ]
        },
        options: {
          scales: {
            y: { position: "left" },
            y1: { position: "right", grid: { drawOnChartArea: false } }
          }
        }
      }
    );

    /** ===============================
     *  Metrics fetch
     *  =============================== */
    async function fetchMetrics() {
      try {
        const res = await fetch("/metrics", {
          headers: {
            Authorization: `Bearer ${TOKEN}`
          }
        });

        if (!res.ok) {
          console.error("metrics fetch failed:", res.status);
          return;
        }

        const data = await res.json();

        document.getElementById("total-requests").textContent =
          data.totalRequests;
        document.getElementById("avg-latency").textContent =
          Math.round(data.avgLatency);
        document.getElementById("error-rate").textContent =
          data.errorRate.toFixed(2);

        const now = new Date().toLocaleTimeString("ko-KR");

        monitoringData.labels.push(now);
        monitoringData.requests.push(data.requestsPerMinute);
        monitoringData.latency.push(data.avgLatency);
        monitoringData.errorRate.push(data.errorRate);

        if (monitoringData.labels.length > monitoringData.max) {
          monitoringData.labels.shift();
          monitoringData.requests.shift();
          monitoringData.latency.shift();
          monitoringData.errorRate.shift();
        }

        requestsChart.data.labels = monitoringData.labels;
        requestsChart.data.datasets[0].data = monitoringData.requests;
        requestsChart.update();

        performanceChart.data.labels = monitoringData.labels;
        performanceChart.data.datasets[0].data = monitoringData.latency;
        performanceChart.data.datasets[1].data = monitoringData.errorRate;
        performanceChart.update();

        document.getElementById("last-update").textContent =
          new Date().toLocaleString("ko-KR");
      } catch (e) {
        console.error("메트릭 가져오기 실패:", e);
      }
    }

    fetchMetrics();
    setInterval(fetchMetrics, 3000);
  </script>
</body>

</html>